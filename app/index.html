<!DOCTYPE html>
<html>

<head>
    <title>Robot control</title>
    <style>
        .button-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            /* justify-items: center; */
            /* grid-auto-flow: row; */
        }

        .move-button {
            width: 200px;
            height: 200px;
        }

        .left-rotate-button {
            grid-column: 1;
            grid-row: 1 / span 3;
            display: flex;
            flex-direction: column;
            /* justify-content: space-between; */
        }

        .right-rotate-button {
            grid-column: 5;
            grid-row: 1 / span 3;
            display: flex;
            flex-direction: column;
            /* justify-content: space-between; */
        }
    </style>
</head>

<body>
    <div class="button-grid">

        <button class="left-rotate-button" id="left-rot">Rotate Left</button>

        <button class="move-button" id="forward-left">Forward Left</button>
        <button class="move-button" id="forward">Forward</button>
        <button class="move-button" id="forward-right">Forward Right</button>

        <button class="move-button" id="left">Left</button>
        <button class="move-button" id="stop">Stop</button>
        <button class="move-button" id="right">Right</button>

        <button class="move-button" id="backward-left">Backward Left</button>
        <button class="move-button" id="backward">Backward</button>
        <button class="move-button" id="backward-right">Backward Right</button>

        <button class="right-rotate-button" id="right-rot">Rotate Right</button>
    </div>

    <script>
        // Function to send a request to the API
        async function sendRequest(direction, speed) {
            try {
                const response = await fetch(`/drive?direction=${direction}&speed=medium`, { method: 'POST' });
                if (response.ok) {
                    console.log(`Driving ${direction}!`);
                } else {
                    console.error("Error sending request!");
                }
            } catch (error) {
                console.error("Error sending request:", error);
            }
        }

        // Add event listeners to the buttons
        document.getElementById("forward-left").addEventListener("click", () => sendRequest("forwardleft", "medium"));
        document.getElementById("forward").addEventListener("click", () => sendRequest("forward", "medium"));
        document.getElementById("forward-right").addEventListener("click", () => sendRequest("forwardright", "medium"));
        document.getElementById("right").addEventListener("click", () => sendRequest("right", "medium"));
        document.getElementById("backward-right").addEventListener("click", () => sendRequest("backwardright", "medium"));
        document.getElementById("backward").addEventListener("click", () => sendRequest("backward", "medium"));
        document.getElementById("backward-left").addEventListener("click", () => sendRequest("backwardleft", "medium"));
        document.getElementById("left").addEventListener("click", () => sendRequest("left", "medium"));
        document.getElementById("stop").addEventListener("click", () => sendRequest("stop", "medium"));
        document.getElementById("left-rot").addEventListener("click", () => sendRequest("leftrot", "medium"));
        document.getElementById("right-rot").addEventListener("click", () => sendRequest("rightrot", "medium"));
    </script>

    <div>
        <button id="connect">Connect</button>
        <span>Status:</span>
        <span id="status">disconnected</span>
    </div>

    <div id="log"></div>

    <form id="chatform">
        <input type="text" id="text" />
        <input type="submit" id="send" />
    </form>

    <hr />

    <section>
        <h2>Usage</h2>
        <p>After connecting, type into the text box and the server will echo your message.</p>
    </section>

    <script>
        const $status = document.querySelector('#status')
        const $connectButton = document.querySelector('#connect')
        const $log = document.querySelector('#log')
        const $form = document.querySelector('#chatform')
        const $input = document.querySelector('#text')

        /** @type {WebSocket | null} */
        var socket = null

        function log(msg, type = 'status') {
            $log.innerHTML += `<p class="msg msg--${type}">${msg}</p>`
            $log.scrollTop += 1000
        }

        function connect() {
            disconnect()

            const { location } = window

            const proto = location.protocol.startsWith('https') ? 'wss' : 'ws'
            const wsUri = `${proto}://${location.host}/ws`

            log('Connecting...')
            socket = new WebSocket(wsUri)

            socket.onopen = () => {
                log('Connected')
                updateConnectionStatus()
            }

            socket.onmessage = (ev) => {
                log('Received: ' + ev.data, 'message')
            }

            socket.onclose = () => {
                log('Disconnected')
                socket = null
                updateConnectionStatus()
            }
        }

        function disconnect() {
            if (socket) {
                log('Disconnecting...')
                socket.close()
                socket = null

                updateConnectionStatus()
            }
        }

        function updateConnectionStatus() {
            if (socket) {
                $status.style.backgroundColor = 'transparent'
                $status.style.color = 'green'
                $status.textContent = `connected`
                $connectButton.innerHTML = 'Disconnect'
                $input.focus()
            } else {
                $status.style.backgroundColor = 'red'
                $status.style.color = 'white'
                $status.textContent = 'disconnected'
                $connectButton.textContent = 'Connect'
            }
        }

        $connectButton.addEventListener('click', () => {
            if (socket) {
                disconnect()
            } else {
                connect()
            }

            updateConnectionStatus()
        })

        $form.addEventListener('submit', (ev) => {
            ev.preventDefault()

            const text = $input.value

            log('Sending: ' + text)
            socket.send(text)

            $input.value = ''
            $input.focus()
        })

        updateConnectionStatus()
    </script>
</body>

</html>